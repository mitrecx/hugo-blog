[{"content":"以下是完整的实现方案，确保在用户未使用新会话前不重复创建：\n步骤 1：修改数据模型 (app.py) class ChatSession(db.Model): id = db.Column(db.String(36), primary_key=True) created_at = db.Column(db.DateTime, default=datetime.datetime.now) is_used = db.Column(db.Boolean, default=False) # 新增字段 messages = db.relationship(\u0026#39;ChatMessage\u0026#39;, backref=\u0026#39;session\u0026#39;, lazy=\u0026#39;dynamic\u0026#39;) 运行数据库迁移：\nflask db init # 如果尚未初始化 flask db migrate -m \u0026#34;Add is_used field\u0026#34; flask db upgrade 步骤 2：修改会话创建接口 (app.py) @app.route(\u0026#39;/create-session\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) def create_session(): try: # 检查是否存在未使用的会话 unused_session = ChatSession.query.filter_by(is_used=False).order_by(ChatSession.created_at.desc()).first() if unused_session: return jsonify({ \u0026#34;success\u0026#34;: True, \u0026#34;session_id\u0026#34;: unused_session.id, \u0026#34;created_at\u0026#34;: unused_session.created_at.strftime(\u0026#34;%Y-%m-%d %H:%M\u0026#34;), \u0026#34;is_new\u0026#34;: False # 标记是否为新建 }) # 创建新会话 response = client.context.create( model=\u0026#39;ep-20250123190804-d927p\u0026#39;, mode=\u0026#34;session\u0026#34;, messages=[{\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;你是豆包，是由字节跳动开发的 AI 人工智能助手\u0026#34;}], ttl=datetime.timedelta(minutes=60) ) token = response.id new_session = ChatSession(id=token, is_used=False) db.session.add(new_session) db.session.commit() return jsonify({ \u0026#34;success\u0026#34;: True, \u0026#34;session_id\u0026#34;: token, \u0026#34;created_at\u0026#34;: new_session.created_at.strftime(\u0026#34;%Y-%m-%d %H:%M\u0026#34;), \u0026#34;is_new\u0026#34;: True }) except Exception as e: return jsonify({\u0026#34;success\u0026#34;: False, \u0026#34;error\u0026#34;: str(e)}), 500 步骤 3：在发送消息时标记会话已使用 (app.py) @app.route(\u0026#39;/chat-stream\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) def chat_stream(): token = request.headers.get(\u0026#39;X-Auth-Token\u0026#39;) user_content = request.json.get(\u0026#39;message\u0026#39;, \u0026#39;\u0026#39;) # 标记会话已使用 current_session = ChatSession.query.get(token) if current_session and not current_session.is_used: current_session.is_used = True db.session.commit() # ...保持原有消息处理逻辑... 步骤 4：修改前端逻辑 (chat.html) async function createSession() { const response = await fetch(\u0026#39;/create-session\u0026#39;, { method: \u0026#39;POST\u0026#39; }); const result = await response.json(); if (result.success) { if (result.is_new) { // 新建会话时刷新页面 window.location.reload(); } else { // 使用现有未使用会话 currentSessionId = result.session_id; document.querySelectorAll(\u0026#39;.session-item\u0026#39;).forEach(item =\u0026gt; { item.classList.remove(\u0026#39;active\u0026#39;); if (item.textContent.includes(result.session_id)) { item.classList.add(\u0026#39;active\u0026#39;); } }); await loadSession(result.session_id); alert(\u0026#39;请继续使用当前未开始的会话\u0026#39;); } } else { alert(\u0026#39;操作失败: \u0026#39; + result.error); } } 方案说明 数据库字段新增：\nis_used 字段用于标识会话是否已被使用（发送过消息） 创建会话逻辑：\n优先返回最近未使用的会话 无未使用会话时才创建新会话 消息发送处理：\n当首次发送消息时自动标记会话为已使用 前端交互优化：\n复用未使用会话时直接加载而不刷新页面 新建会话时强制刷新保证数据同步 验证方法 测试场景 1：\n点击「新建会话」→ 创建新会话 不发送消息，再次点击「新建会话」→ 提示使用现有会话 测试场景 2：\n创建新会话后发送一条消息 再次点击「新建会话」→ 正常创建新会话 数据库检查：\nSELECT id, is_used FROM chat_session; -- 未发送消息的会话应标记为 is_used=0 -- 已发送消息的会话应标记为 is_used=1 该方案通过后端状态跟踪和前端提示，有效避免了重复创建未使用的会话。\n","permalink":"http://localhost:1313/post/t2/","summary":"\u003cp\u003e以下是完整的实现方案，确保在用户未使用新会话前不重复创建：\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"步骤-1修改数据模型-apppy\"\u003e步骤 1：修改数据模型 (app.py)\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eChatSession\u003c/span\u003e(db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eModel):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eColumn(db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eString(\u003cspan style=\"color:#ae81ff\"\u003e36\u003c/span\u003e), primary_key\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    created_at \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eColumn(db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eDateTime, default\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003edatetime\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003edatetime\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003enow)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    is_used \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eColumn(db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eBoolean, default\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e)  \u003cspan style=\"color:#75715e\"\u003e# 新增字段\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    messages \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003erelationship(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ChatMessage\u0026#39;\u003c/span\u003e, backref\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;session\u0026#39;\u003c/span\u003e, lazy\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;dynamic\u0026#39;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e运行数据库迁移：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eflask db init  \u003cspan style=\"color:#75715e\"\u003e# 如果尚未初始化\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eflask db migrate -m \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Add is_used field\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eflask db upgrade\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch3 id=\"步骤-2修改会话创建接口-apppy\"\u003e步骤 2：修改会话创建接口 (app.py)\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@app.route\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;/create-session\u0026#39;\u003c/span\u003e, methods\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e[\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecreate_session\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003etry\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#75715e\"\u003e# 检查是否存在未使用的会话\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        unused_session \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ChatSession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003equery\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efilter_by(is_used\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eorder_by(ChatSession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecreated_at\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003edesc())\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efirst()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e unused_session:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e jsonify({\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;success\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;session_id\u0026#34;\u003c/span\u003e: unused_session\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eid,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;created_at\u0026#34;\u003c/span\u003e: unused_session\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecreated_at\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003estrftime(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;%Y-%m-\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e%d\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e %H:%M\u0026#34;\u003c/span\u003e),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;is_new\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# 标记是否为新建\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            })\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#75715e\"\u003e# 创建新会话\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        response \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e client\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003econtext\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecreate(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            model\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ep-20250123190804-d927p\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            mode\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;session\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            messages\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e[{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;system\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;你是豆包，是由字节跳动开发的 AI 人工智能助手\u0026#34;\u003c/span\u003e}],\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            ttl\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003edatetime\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003etimedelta(minutes\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e60\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        token \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e response\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eid\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        new_session \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ChatSession(id\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003etoken, is_used\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eadd(new_session)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecommit()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e jsonify({\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;success\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;session_id\u0026#34;\u003c/span\u003e: token,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;created_at\u0026#34;\u003c/span\u003e: new_session\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecreated_at\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003estrftime(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;%Y-%m-\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e%d\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e %H:%M\u0026#34;\u003c/span\u003e),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;is_new\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        })\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eexcept\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eException\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eas\u003c/span\u003e e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e jsonify({\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;success\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;error\u0026#34;\u003c/span\u003e: str(e)}), \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch3 id=\"步骤-3在发送消息时标记会话已使用-apppy\"\u003e步骤 3：在发送消息时标记会话已使用 (app.py)\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@app.route\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;/chat-stream\u0026#39;\u003c/span\u003e, methods\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e[\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003echat_stream\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    token \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eheaders\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eget(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;X-Auth-Token\u0026#39;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    user_content \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ejson\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eget(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 标记会话已使用\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    current_session \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ChatSession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003equery\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eget(token)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e current_session \u003cspan style=\"color:#f92672\"\u003eand\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003enot\u003c/span\u003e current_session\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eis_used:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        current_session\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eis_used \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecommit()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# ...保持原有消息处理逻辑...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch3 id=\"步骤-4修改前端逻辑-chathtml\"\u003e步骤 4：修改前端逻辑 (chat.html)\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-javascript\" data-lang=\"javascript\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003easync\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecreateSession\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresponse\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eawait\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efetch\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;/create-session\u0026#39;\u003c/span\u003e, { \u003cspan style=\"color:#a6e22e\"\u003emethod\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e });\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eawait\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresponse\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ejson\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esuccess\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eis_new\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#75715e\"\u003e// 新建会话时刷新页面\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e            window.\u003cspan style=\"color:#a6e22e\"\u003elocation\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ereload\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        } \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#75715e\"\u003e// 使用现有未使用会话\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e            \u003cspan style=\"color:#a6e22e\"\u003ecurrentSessionId\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esession_id\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            document.\u003cspan style=\"color:#a6e22e\"\u003equerySelectorAll\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;.session-item\u0026#39;\u003c/span\u003e).\u003cspan style=\"color:#a6e22e\"\u003eforEach\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e =\u0026gt; {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eclassList\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eremove\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;active\u0026#39;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003etextContent\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eincludes\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esession_id\u003c/span\u003e)) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    \u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eclassList\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eadd\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;active\u0026#39;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            });\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003eawait\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eloadSession\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esession_id\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ealert\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;请继续使用当前未开始的会话\u0026#39;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    } \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ealert\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;操作失败: \u0026#39;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eerror\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch3 id=\"方案说明\"\u003e方案说明\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e数据库字段新增\u003c/strong\u003e：\u003c/p\u003e","title":"T2"},{"content":"以下是完整的实现方案，确保在用户未使用新会话前不重复创建：\n步骤 1：修改数据模型 (app.py) class ChatSession(db.Model): id = db.Column(db.String(36), primary_key=True) created_at = db.Column(db.DateTime, default=datetime.datetime.now) is_used = db.Column(db.Boolean, default=False) # 新增字段 messages = db.relationship(\u0026#39;ChatMessage\u0026#39;, backref=\u0026#39;session\u0026#39;, lazy=\u0026#39;dynamic\u0026#39;) 运行数据库迁移：\nflask db init # 如果尚未初始化 flask db migrate -m \u0026#34;Add is_used field\u0026#34; flask db upgrade 步骤 2：修改会话创建接口 (app.py) @app.route(\u0026#39;/create-session\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) def create_session(): try: # 检查是否存在未使用的会话 unused_session = ChatSession.query.filter_by(is_used=False).order_by(ChatSession.created_at.desc()).first() if unused_session: return jsonify({ \u0026#34;success\u0026#34;: True, \u0026#34;session_id\u0026#34;: unused_session.id, \u0026#34;created_at\u0026#34;: unused_session.created_at.strftime(\u0026#34;%Y-%m-%d %H:%M\u0026#34;), \u0026#34;is_new\u0026#34;: False # 标记是否为新建 }) # 创建新会话 response = client.context.create( model=\u0026#39;ep-20250123190804-d927p\u0026#39;, mode=\u0026#34;session\u0026#34;, messages=[{\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;你是豆包，是由字节跳动开发的 AI 人工智能助手\u0026#34;}], ttl=datetime.timedelta(minutes=60) ) token = response.id new_session = ChatSession(id=token, is_used=False) db.session.add(new_session) db.session.commit() return jsonify({ \u0026#34;success\u0026#34;: True, \u0026#34;session_id\u0026#34;: token, \u0026#34;created_at\u0026#34;: new_session.created_at.strftime(\u0026#34;%Y-%m-%d %H:%M\u0026#34;), \u0026#34;is_new\u0026#34;: True }) except Exception as e: return jsonify({\u0026#34;success\u0026#34;: False, \u0026#34;error\u0026#34;: str(e)}), 500 步骤 3：在发送消息时标记会话已使用 (app.py) @app.route(\u0026#39;/chat-stream\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) def chat_stream(): token = request.headers.get(\u0026#39;X-Auth-Token\u0026#39;) user_content = request.json.get(\u0026#39;message\u0026#39;, \u0026#39;\u0026#39;) # 标记会话已使用 current_session = ChatSession.query.get(token) if current_session and not current_session.is_used: current_session.is_used = True db.session.commit() # ...保持原有消息处理逻辑... 步骤 4：修改前端逻辑 (chat.html) async function createSession() { const response = await fetch(\u0026#39;/create-session\u0026#39;, { method: \u0026#39;POST\u0026#39; }); const result = await response.json(); if (result.success) { if (result.is_new) { // 新建会话时刷新页面 window.location.reload(); } else { // 使用现有未使用会话 currentSessionId = result.session_id; document.querySelectorAll(\u0026#39;.session-item\u0026#39;).forEach(item =\u0026gt; { item.classList.remove(\u0026#39;active\u0026#39;); if (item.textContent.includes(result.session_id)) { item.classList.add(\u0026#39;active\u0026#39;); } }); await loadSession(result.session_id); alert(\u0026#39;请继续使用当前未开始的会话\u0026#39;); } } else { alert(\u0026#39;操作失败: \u0026#39; + result.error); } } 方案说明 数据库字段新增：\nis_used 字段用于标识会话是否已被使用（发送过消息） 创建会话逻辑：\n优先返回最近未使用的会话 无未使用会话时才创建新会话 消息发送处理：\n当首次发送消息时自动标记会话为已使用 前端交互优化：\n复用未使用会话时直接加载而不刷新页面 新建会话时强制刷新保证数据同步 验证方法 测试场景 1：\n点击「新建会话」→ 创建新会话 不发送消息，再次点击「新建会话」→ 提示使用现有会话 测试场景 2：\n创建新会话后发送一条消息 再次点击「新建会话」→ 正常创建新会话 数据库检查：\nSELECT id, is_used FROM chat_session; -- 未发送消息的会话应标记为 is_used=0 -- 已发送消息的会话应标记为 is_used=1 该方案通过后端状态跟踪和前端提示，有效避免了重复创建未使用的会话。\n","permalink":"http://localhost:1313/post/t1/","summary":"\u003cp\u003e以下是完整的实现方案，确保在用户未使用新会话前不重复创建：\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"步骤-1修改数据模型-apppy\"\u003e步骤 1：修改数据模型 (app.py)\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eChatSession\u003c/span\u003e(db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eModel):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eColumn(db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eString(\u003cspan style=\"color:#ae81ff\"\u003e36\u003c/span\u003e), primary_key\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    created_at \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eColumn(db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eDateTime, default\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003edatetime\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003edatetime\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003enow)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    is_used \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eColumn(db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eBoolean, default\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e)  \u003cspan style=\"color:#75715e\"\u003e# 新增字段\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    messages \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003erelationship(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ChatMessage\u0026#39;\u003c/span\u003e, backref\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;session\u0026#39;\u003c/span\u003e, lazy\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;dynamic\u0026#39;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e运行数据库迁移：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eflask db init  \u003cspan style=\"color:#75715e\"\u003e# 如果尚未初始化\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eflask db migrate -m \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Add is_used field\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eflask db upgrade\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch3 id=\"步骤-2修改会话创建接口-apppy\"\u003e步骤 2：修改会话创建接口 (app.py)\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@app.route\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;/create-session\u0026#39;\u003c/span\u003e, methods\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e[\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecreate_session\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003etry\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#75715e\"\u003e# 检查是否存在未使用的会话\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        unused_session \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ChatSession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003equery\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efilter_by(is_used\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eorder_by(ChatSession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecreated_at\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003edesc())\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efirst()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e unused_session:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e jsonify({\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;success\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;session_id\u0026#34;\u003c/span\u003e: unused_session\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eid,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;created_at\u0026#34;\u003c/span\u003e: unused_session\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecreated_at\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003estrftime(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;%Y-%m-\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e%d\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e %H:%M\u0026#34;\u003c/span\u003e),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;is_new\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# 标记是否为新建\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            })\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#75715e\"\u003e# 创建新会话\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        response \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e client\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003econtext\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecreate(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            model\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ep-20250123190804-d927p\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            mode\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;session\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            messages\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e[{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;system\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;你是豆包，是由字节跳动开发的 AI 人工智能助手\u0026#34;\u003c/span\u003e}],\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            ttl\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003edatetime\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003etimedelta(minutes\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e60\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        token \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e response\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eid\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        new_session \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ChatSession(id\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003etoken, is_used\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eadd(new_session)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecommit()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e jsonify({\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;success\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;session_id\u0026#34;\u003c/span\u003e: token,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;created_at\u0026#34;\u003c/span\u003e: new_session\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecreated_at\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003estrftime(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;%Y-%m-\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e%d\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e %H:%M\u0026#34;\u003c/span\u003e),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;is_new\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        })\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eexcept\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eException\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eas\u003c/span\u003e e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e jsonify({\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;success\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;error\u0026#34;\u003c/span\u003e: str(e)}), \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch3 id=\"步骤-3在发送消息时标记会话已使用-apppy\"\u003e步骤 3：在发送消息时标记会话已使用 (app.py)\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@app.route\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;/chat-stream\u0026#39;\u003c/span\u003e, methods\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e[\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003echat_stream\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    token \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eheaders\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eget(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;X-Auth-Token\u0026#39;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    user_content \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ejson\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eget(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 标记会话已使用\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    current_session \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ChatSession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003equery\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eget(token)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e current_session \u003cspan style=\"color:#f92672\"\u003eand\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003enot\u003c/span\u003e current_session\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eis_used:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        current_session\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eis_used \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        db\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esession\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecommit()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# ...保持原有消息处理逻辑...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch3 id=\"步骤-4修改前端逻辑-chathtml\"\u003e步骤 4：修改前端逻辑 (chat.html)\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-javascript\" data-lang=\"javascript\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003easync\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecreateSession\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresponse\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eawait\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efetch\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;/create-session\u0026#39;\u003c/span\u003e, { \u003cspan style=\"color:#a6e22e\"\u003emethod\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e });\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eawait\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresponse\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ejson\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esuccess\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eis_new\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#75715e\"\u003e// 新建会话时刷新页面\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e            window.\u003cspan style=\"color:#a6e22e\"\u003elocation\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ereload\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        } \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#75715e\"\u003e// 使用现有未使用会话\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e            \u003cspan style=\"color:#a6e22e\"\u003ecurrentSessionId\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esession_id\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            document.\u003cspan style=\"color:#a6e22e\"\u003equerySelectorAll\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;.session-item\u0026#39;\u003c/span\u003e).\u003cspan style=\"color:#a6e22e\"\u003eforEach\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e =\u0026gt; {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eclassList\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eremove\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;active\u0026#39;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003etextContent\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eincludes\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esession_id\u003c/span\u003e)) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    \u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eclassList\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eadd\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;active\u0026#39;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            });\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003eawait\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eloadSession\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esession_id\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ealert\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;请继续使用当前未开始的会话\u0026#39;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    } \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ealert\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;操作失败: \u0026#39;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresult\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eerror\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003ch3 id=\"方案说明\"\u003e方案说明\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e数据库字段新增\u003c/strong\u003e：\u003c/p\u003e","title":"T1"},{"content":"方法 1: 使用内置的 Fuse.js 搜索 (推荐) PaperMod 默认集成了基于 Fuse.js 的客户端搜索功能，只需简单配置即可启用：\n启用搜索配置 在 config.yml 中添加：\nparams: enableSearch: true 生成搜索索引 确保你的内容能被索引。在 config.yml 中配置 Hugo 生成 JSON 索引文件：\noutputs: home: - HTML - RSS - JSON 创建搜索页面 新建 content/search.md 文件，内容如下：\n--- title: \u0026#34;搜索\u0026#34; layout: \u0026#34;search\u0026#34; summary: \u0026#34;搜索页面\u0026#34; placeholder: \u0026#34;输入关键词...\u0026#34; --- 添加搜索入口 在菜单中添加链接（修改 config.yml）：\nmenu: main: - name: \u0026#34;搜索\u0026#34; url: /search weight: 5 方法 2: 自定义 Algolia 搜索（适合大型站点） 注册 Algolia 账号 访问 Algolia 并创建索引。\n安装 Hugo-Algolia 工具\nnpm install -D hugo-algolia 配置 Algolia 在 config.yml 中添加：\nparams: algolia: appId: \u0026#34;你的APP_ID\u0026#34; apiKey: \u0026#34;你的SEARCH_API_KEY\u0026#34; indexName: \u0026#34;你的索引名称\u0026#34; 生成索引并上传 创建 package.json 脚本：\n\u0026#34;scripts\u0026#34;: { \u0026#34;index\u0026#34;: \u0026#34;hugo-algolia -s\u0026#34; } 运行：\nnpm run index 添加搜索模板 在 layouts/partials/search_algolia.html 创建自定义模板。\n方法 3: 手动实现 Lunr.js 搜索 生成索引文件 创建 layouts/index.json 定义数据结构。\n添加 Lunr.js 在 assets/js/search.js 中添加：\nfetch(\u0026#39;/index.json\u0026#39;).then(res =\u0026gt; res.json()).then(data =\u0026gt; { const idx = lunr(function() { this.ref(\u0026#39;id\u0026#39;) this.field(\u0026#39;title\u0026#39;, { boost: 10 }) this.field(\u0026#39;content\u0026#39;) }); // 添加索引逻辑... }); 创建搜索界面 参考方法1中的 search.md 页面。\n样式调整 在 assets/css/extended/search.css 中添加自定义样式：\n.search-results { margin-top: 2rem; } .search-result-item { border-bottom: 1px solid #eee; padding: 1rem 0; } 常见问题排查：\n确保运行 hugo server 时包含 --buildDrafts 参数（如果需要索引草稿） 检查浏览器控制台是否有404错误（确认index.json路径正确） 清除浏览器缓存后再测试 确认 Hugo 版本 ≥ 0.68.0 (兼容性问题) 完成后，你的网站将会在 /search 路径下显示搜索界面，支持实时关键词检索。\n","permalink":"http://localhost:1313/post/t3/","summary":"\u003ch3 id=\"方法-1-使用内置的-fusejs-搜索-推荐\"\u003e方法 1: 使用内置的 Fuse.js 搜索 (推荐)\u003c/h3\u003e\n\u003cp\u003ePaperMod 默认集成了基于 Fuse.js 的客户端搜索功能，只需简单配置即可启用：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e启用搜索配置\u003c/strong\u003e\n在 \u003ccode\u003econfig.yml\u003c/code\u003e 中添加：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eparams\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003eenableSearch\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e生成搜索索引\u003c/strong\u003e\n确保你的内容能被索引。在 \u003ccode\u003econfig.yml\u003c/code\u003e 中配置 Hugo 生成 JSON 索引文件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eoutputs\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003ehome\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    - \u003cspan style=\"color:#ae81ff\"\u003eHTML\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    - \u003cspan style=\"color:#ae81ff\"\u003eRSS\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    - \u003cspan style=\"color:#ae81ff\"\u003eJSON\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e创建搜索页面\u003c/strong\u003e\n新建 \u003ccode\u003econtent/search.md\u003c/code\u003e 文件，内容如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-markdown\" data-lang=\"markdown\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etitle: \u0026#34;搜索\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003elayout: \u0026#34;search\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esummary: \u0026#34;搜索页面\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eplaceholder: \u0026#34;输入关键词...\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e添加搜索入口\u003c/strong\u003e\n在菜单中添加链接（修改 \u003ccode\u003econfig.yml\u003c/code\u003e）：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003emenu\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003emain\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    - \u003cspan style=\"color:#f92672\"\u003ename\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;搜索\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      \u003cspan style=\"color:#f92672\"\u003eurl\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e/search\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      \u003cspan style=\"color:#f92672\"\u003eweight\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch3 id=\"方法-2-自定义-algolia-搜索适合大型站点\"\u003e方法 2: 自定义 Algolia 搜索（适合大型站点）\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e注册 Algolia 账号\u003c/strong\u003e\n访问 \u003ca href=\"https://www.algolia.com/\"\u003eAlgolia\u003c/a\u003e 并创建索引。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e安装 Hugo-Algolia 工具\u003c/strong\u003e\u003c/p\u003e","title":"T3"}]